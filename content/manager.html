<!DOCTYPE html>
<html>
<head>
    <title>Manage your TLSNotary notarization files.</title>
</head>
<body onload="loadManager()">
<div id="myform">
<b>Simple form with name and age ...</b>
<table>
    <tr>
        <td>Name:</td>
        <td><input type="text" id="name"></td>
    </tr>
    <tr>
        <td>Age:</td>
        <td><input type="text" id="age">
        <input type="button" id="add" value="Add" onclick="Javascript:addRow()"></td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
    </tr>
</table>
</div>
<div id="mydata">
<b>Existing notarization (.tlsn) files ...</b>
<table id="myTableData"  border="1" cellpadding="2">
    <tr>
        <td>Filename</td>
        <td><b>Last modified</b></td>
        <td><b>Verified</b></td>
	<td><b>Verifier identity</b></td>
	
    </tr>
</table>
&nbsp;
 
</div>
<div id="myDynamicTable">
<input type="button" id="create" value="Click here" onclick="Javascript:addTable()">
to create a Table and add some data using JavaScript
</div>

<script type="text/javascript;version=1.8" src="main.js"></script>
<script type="text/javascript;version=1.8" src="tlsn_utils.js"></script>
<script type="text/javascript;version=1.8">

var tlsn_files = [];

function addRow() {
          
    var myName = document.getElementById("name");
    var age = document.getElementById("age");
    var table = document.getElementById("myTableData");
 
    var rowCount = table.rows.length;
    var row = table.insertRow(rowCount);
 
    row.insertCell(0).innerHTML= '<input type="button" value = "Delete" onClick="Javacsript:deleteRow(this)">';
    row.insertCell(1).innerHTML= myName.value;
    row.insertCell(2).innerHTML= age.value;
 
}

function addRowTLSN(filename,lm_date,verified,verifier){
    var table = document.getElementById("myTableData");
    var rowCount = table.rows.length;
    var row = table.insertRow(rowCount);
    row.insertCell(0).innerHTML = filename;
    row.insertCell(1).innerHTML = lm_date;
    if (verified){
	tbi = 'YES';
    }
    else {
        tbi = 'NO';
    }
    row.insertCell(2).innerHTML = tbi;
    row.insertCell(3).innerHTML = verifier;
}
function deleteRow(obj) {
      
    var index = obj.parentNode.parentNode.rowIndex;
    var table = document.getElementById("myTableData");
    table.deleteRow(index);
    
}
 
function addTable() {
      
    var myTableDiv = document.getElementById("myDynamicTable");
      
    var table = document.createElement('TABLE');
    table.border='1';
    
    var tableBody = document.createElement('TBODY');
    table.appendChild(tableBody);
      
    for (var i=0; i<3; i++){
       var tr = document.createElement('TR');
       tableBody.appendChild(tr);
       
       for (var j=0; j<4; j++){
           var td = document.createElement('TD');
           td.width='75';
           td.appendChild(document.createTextNode("Cell " + i + "," + j));
           tr.appendChild(td);
       }
    }
    myTableDiv.appendChild(table);
    
}

function loadManager() {
   tlsn_files = [];
   var tlsn_lmdates = [];
Cu2.import("resource://gre/modules/osfile.jsm");
    // Open iterator
 //let thepath = getTLSNdir();
 //console.log("Path found was: "+thepath);	
  let iterator = new OS.File.DirectoryIterator(getTLSNdir().path);
   //Iterate through the directory
  let promise = iterator.forEach(
    function onEntry(entry) {
	tlsn_files.push(entry);
	
	let promise2 = OS.File.stat(entry.path);
	promise2.then(
	function onSuccess(info) { // |info| is an instance of |OS.File.Info|
	    console.log("last mod time: " + info.lastModificationDate);
	    tlsn_lmdates.push(info.lastModificationDate);
	},
	function onFailure(reason) {
	  console.log("File access failure");
	})
    }
  );
  
  // Finally, close the iterator
  promise.then(
    function onSuccess() {
      iterator.close();
      for ( i=0; i < tlsn_files.length; i++){
        //sanity check; all files here should be directories;
	//if the user has placed any other files there, ignore them.
	if (!tlsn_files[i].isDir){
	    console.log("entry was not a directory");
	    continue;
	}
	addRowTLSN(tlsn_files[i].name,tlsn_lmdates[i],true,'tlsnotarygroup');
	//build file path  of *.tlsn within the directory
	var basepath = tlsn_files[i].path;
	console.log("basepath is: "+basepath);
	var dirname = OS.Path.basename(basepath);
	console.log("dirname is: "+dirname);
	
	if (dirname.match("-IMPORTED$")=="-IMPORTED"){
	    dirname = dirname.slice(0,-"-IMPORTED".length);
	}
	console.log("Got dirname: " + dirname);
	var tlsn_file = OS.Path.join(basepath, dirname+'.tlsn');
	console.log("Constructed file path: "+tlsn_file);
	verify_tlsn_and_show_html(tlsn_file);
      }
      
    },
    function onFailure(reason) {
      iterator.close();
      throw reason;
    }
  ); 
    console.log("Page load finished");
 
}

</script>
</body>
</html>